const STATE = require('STATE')
const statedb = STATE(__filename)
const { sdb, get } = statedb(fallback_module)

module.exports = search_bar

async function search_bar(opts = {}, protocol) {
  const { id, sdb } = await get(opts.sid)
  const { drive } = sdb

  const on = { style: inject, data: ondata, icons: iconject }

  const el = document.createElement('div')
  const shadow = el.attachShadow({ mode: 'closed' })
  let dricons = []

  shadow.innerHTML = `
    <div class="search-bar">
      <input type="text" class="search-input" placeholder="Search" style="border:none; outline:none; font-size:14px; background:transparent; flex:1;" />
      <div class="search-icon"><div class="icon-slot"></div></div>
      <style></style>
    </div>
  `

  const style = shadow.querySelector('style')
  const input = shadow.querySelector('.search-input')
  const icon = shadow.querySelector('.search-icon')

  // ðŸ”¥ PROTOCOL
  const sendToParent = msg => protocol?.(msg)

  input.addEventListener('input', e => {
    // optional live search
    // sendToParent({ type: 'typing', value: e.target.value })
  })

  icon.addEventListener('click', () => {
    sendToParent({ type: 'search', value: input.value })
  })

  await sdb.watch(onbatch)
  return el

  function fail(data, type) { throw new Error('invalid message', { cause: { data, type } }) }
  async function onbatch(batch) { 
    for (const { type, paths } of batch) {
      const data = await Promise.all(paths.map(path => drive.get(path).then(f => f.raw)))
      const func = on[type] || fail
      await func(data, type)
    }
  }

  function inject(data) { style.textContent = data[0] }
  async function ondata(data) {}
  function iconject(data) { 
    dricons = data
    const icon_slot = shadow.querySelector('.icon-slot')
    if (icon_slot && dricons[0]) icon_slot.innerHTML = dricons[0]
  }
}

// Fallback module omitted for brevity (keep your current)

function fallback_module () {
  return {
    api: fallback_instance
  }
  function fallback_instance (opts) {
    if (!opts) opts = {}
    if (!opts.value) opts.value = {}

    return {
        drive: {
          'icons/':{
            'search.svg':{
              '$ref': 'search.svg'
            }
          },
          'style/':{
            'style.css':{
              '$ref': 'search_bar.css'
            }
          },
          'data/': {
            'opts.json': {
              raw: opts || {}
            }
          }
        }
    }
  }
}
